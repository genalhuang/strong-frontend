### ç®€ä»‹
ğŸ˜› é—²æš‡æ—¶é—´æƒ³åšä¸€ä¸ªèŠå¤©å®¤å¤ç›˜ä¸€ä¸‹è¿™äº›å¹´å­¦ä¹ åˆ°çš„æŠ€æœ¯ï¼Œäºæ˜¯åœ¨2020å¹´6æœˆ24å·å°±å¼€å§‹äº†GenalèŠå¤©å®¤çš„å¼€å‘ä¹‹æ—…ã€‚<br>
ğŸ˜ˆ é¡¹ç›®é‡‡ç”¨å…¨typescriptå¼€å‘ï¼Œè¿™æ˜¯ä¸ºäº†ä»¥åçš„åŠŸèƒ½è¿­ä»£æ‰“åŸºç¡€ã€‚å½“ç„¶ï¼Œæˆ‘æœ¬èº«ä¹Ÿæ˜¯å¾ˆå–œæ¬¢typescriptçš„ã€‚

### é¡¹ç›®ç•Œé¢
![](./genal.gif)

### åŠŸèƒ½ä»‹ç»
- æ›´æ”¹ç”¨æˆ·å/å¤´åƒä¸Šä¼ 
- ç¾¤èŠ/ç§èŠ
- åˆ›å»ºç¾¤/åŠ å…¥ç¾¤èŠ/æ¨¡ç³Šæœç´¢ç¾¤
- æ·»åŠ å¥½å‹/æ¨¡ç³Šæœç´¢å¥½å‹
- è¡¨æƒ…åŒ…
- æ¶ˆæ¯åˆ†é¡µ

### æŠ€æœ¯æ¦‚è§ˆ
- Typescriptï¼šJavaScript çš„ä¸€ä¸ªè¶…é›†ï¼Œå®ƒæœ€å¤§çš„ä¼˜åŠ¿æ˜¯æä¾›äº†ç±»å‹ç³»ç»Ÿå’Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
- Vue2.6.xï¼šå‰ç«¯æ¸è¿›å¼æ¡†æ¶ã€‚
- Socket.ioï¼šå®ç°å®æ—¶é€šä¿¡ï¼Œwebsocketç¬¬ä¸‰æ–¹åº“ã€‚
- Vuexï¼šä¸“ä¸º Vue.js åº”ç”¨ç¨‹åºå¼€å‘çš„çŠ¶æ€ç®¡ç†æ¨¡å¼ã€‚
- Nestjsï¼šæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé«˜æ•ˆã€å¯æ‰©å±•çš„ Node.js æœåŠ¡ç«¯åº”ç”¨æ¡†æ¶ï¼ŒåŸºäº TypeScript ç¼–å†™å¹¶ä¸”ç»“åˆäº† OOP1ã€FP2ã€FRP3 çš„ç›¸å…³ç†å¿µã€‚
- Typeorm: æ”¯æŒæœ€æ–°çš„ JavaScript ç‰¹æ€§å¹¶æä¾›é¢å¤–çš„ç‰¹æ€§ä»¥å¸®åŠ©ä½ å¼€å‘ä»»ä½•ä½¿ç”¨æ•°æ®åº“çš„åº”ç”¨ç¨‹åºã€‚
- ES6+ï¼šé‡‡ç”¨ES6+è¯­æ³•ï¼Œç®­å¤´å‡½æ•°ã€async/awaitç­‰ç­‰è¯­æ³•å¾ˆå¥½ç”¨ã€‚
- SASS(SCSS)ï¼šç”¨SCSSåšCSSé¢„å¤„ç†è¯­è¨€ï¼Œå¯ä»¥ä½¿ç”¨æœ€é«˜æ•ˆçš„æ–¹å¼ï¼Œä»¥å°‘é‡çš„ä»£ç åˆ›å»ºå¤æ‚çš„è®¾è®¡ã€‚


### æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
æ•°æ®åº“ä½¿ç”¨äº†å…­å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯
- user ç”¨æˆ·è¡¨
- group ç¾¤è¡¨ 
- user_group ç”¨æˆ·_ç¾¤ä¸­é—´è¡¨
- group_message ç¾¤æ¶ˆæ¯è¡¨
- user_friend ç”¨æˆ·_å¥½å‹ä¸­é—´è¡¨
- friend_message ç§èŠæ¶ˆæ¯è¡¨

å…¶ä¸­ä¸­é—´è¡¨ç”¨äºå»ºç«‹å¯¹äºç¾¤/å¥½å‹ä¸ç”¨æˆ·ä¹‹é—´çš„è”ç³»ã€‚ä¸‹é¢æ˜¯æˆ‘ç”»çš„æ€ç»´å¯¼å›¾ï¼Œç›¸ä¿¡å¤§å®¶çœ‹å®Œå°±èƒ½ç†è§£å…¶ä¸­çš„å¥¥å¦™å•¦ã€‚<br>

![](./database.png)


### WebSocketçš„å»ºç«‹é€»è¾‘
#### ç”¨æˆ·æˆ¿é—´çš„å»ºç«‹
æ¯ä¸ªç”¨æˆ·è¿›å…¥èŠå¤©å®¤éƒ½ä¼šè‡ªåŠ¨åŠ å…¥publicèŠå¤©ç»„ï¼Œå¹¶ä¸”æ¯ä¸ªç”¨æˆ·éƒ½ä¼šè¿›å…¥ç”±ç”¨æˆ·idä¸ºåå­—çš„ WebSocket æˆ¿é—´ï¼Œé‚£ä¹ˆåšæ˜¯ä¸ºäº†å•ç‹¬å¹¿æ’­ç»™æŸä¸ªç”¨æˆ·ä»è€Œè¿›è¡Œä¸€äº›æ“ä½œã€‚å¦‚æœä¸äº†è§£æˆ¿é—´çš„æ¦‚å¿µï¼Œå¯ä»¥è®¤ä¸ºåªæœ‰æˆ¿é—´å†…çš„äººæ‰èƒ½æ¥æ”¶åˆ°æˆ¿é—´çš„å¹¿æ’­ï¼Œæ›´å¤šä¿¡æ¯è¯·ç§»æ­¥socket.ioå®˜ç½‘ã€‚

#### ç¾¤èŠæˆ¿é—´çš„å»ºç«‹
ä»¥groupIdä½œä¸ºWebSocketæˆ¿é—´çš„åå­—ï¼Œæ¯æ¬¡æœ‰æ–°ç”¨æˆ·åŠ å…¥ç¾¤éƒ½ä¼šåœ¨ç¾¤æˆ¿é—´å†…å¹¿æ’­ç”¨æˆ·è¿›ç¾¤äº‹ä»¶ï¼Œç„¶åå…¶ä»–ç”¨æˆ·ä¼šå­˜å‚¨æ–°ç”¨æˆ·çš„ä¿¡æ¯ã€‚å½“æ–°ç”¨æˆ·å‘æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡æ¶ˆæ¯çš„userIdæ‰¾åˆ°å¯¹åº”ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿™æ ·èƒ½ä¿éšœæ¶ˆæ¯å‘é€çš„é€Ÿåº¦.

#### ç§èŠæˆ¿é—´çš„å»ºç«‹
æ¯å½“å‘èµ·ä¸€ä¸ªæ·»åŠ å¥½å‹çš„è¯·æ±‚ï¼Œå°±ä¼šæŠŠç”¨æˆ·userIdå’Œå¥½å‹çš„userIdæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºWebSocketçš„æˆ¿é—´åï¼Œä»è€Œå»ºç«‹ç§èŠæˆ¿é—´ã€‚

### åç«¯æ¶æ„
åç«¯ä½¿ç”¨äº†nestjsè¿™ä¸ªè¿‘å‡ å¹´å‘å±•è¿…çŒ›çš„node.jsæ¡†æ¶ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºå…¶ä½¿ç”¨typescriptè¿›è¡Œå¼€å‘ï¼Œnestjsçš„ä¾èµ–æ³¨å…¥ä»¥åŠæ¨¡å—åŒ–çš„æ€æƒ³ï¼Œä½¿å¾—ä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤ã€‚åŒæ—¶nestjsçš„@nestjs/websocketsåŒ…ä¹Ÿå·²ç»å°è£…å¥½äº†å¯¹äºWebSocketäº‹ä»¶çš„å¤„ç†ã€‚ä¸‹é¢æ˜¯ä¸€äº›åç«¯çš„é€»è¾‘ä»£ç ã€‚
1. ä½¿ç”¨nestjså»ºç«‹WebSocketè¿æ¥
```js
// chat.gateway.ts
@WebSocketGateway()
export class ChatGateway {
  // socketè¿æ¥é’©å­
  async handleConnection(client: Socket): Promise<string> {
    let userRoom = client.handshake.query.userId;
    // è¿æ¥é»˜è®¤åŠ å…¥publicæˆ¿é—´
    client.join('public');
    // ç”¨æˆ·ç‹¬æœ‰æ¶ˆæ¯æˆ¿é—´ æ ¹æ®userId
    if(userRoom) {
      client.join(userRoom);
    }
    return 'è¿æ¥æˆåŠŸ'
  }
}
```
2. å°è£…å…¨å±€çš„ä¸­é—´ä»¶ï¼Œæ–¹ä¾¿åœ¨å¼€å‘è¿‡ç¨‹ä¸­è°ƒè¯•ã€‚
```js
// middleware.js
export function logger(req, res, next) {
  const { method, path } = req;
  console.log(`${method} ${path}`);
  next();
};

// main.js 
ä½¿ç”¨å…¨å±€ä¸­é—´ä»¶
app.use(logger)
```
3. nestjsçš„é™æ€èµ„æºé…ç½®
```js
// main.js
é…ç½®é™æ€èµ„æº
app.useStaticAssets(join(__dirname, '../public/', 'static'), {
  prefix: '/static/', 
});
```
4. nestjsè¿˜èƒ½è‡ªå®šä¹‰å¼‚å¸¸è¿‡æ»¤å™¨
```js
// http-exception.filter.ts
@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter<HttpException> {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();
    const status = exception.getStatus();
    const exceptionRes: any = exception.getResponse();
    const {
      error,
      message,
    } = exceptionRes;
    // ä»¥ä¸‹æ ¼å¼å°†åœ¨å‘ç”Ÿé”™è¯¯æ˜¯è¿”å›ç»™å‰ç«¯
    response.status(status).json({
      status,
      timestamp: new Date().toISOString(),
      path: request.url,
      error,
      message,
    });
  }
}
```

### å‰ç«¯
#### é¡µé¢åˆå§‹åŒ–
åˆå§‹åŒ–ä¼šè°ƒèµ·WebSocketè¿æ¥å‡½æ•°ï¼Œç„¶åæ‹¿åˆ°ç”¨æˆ·æ‰€æœ‰çš„ç¾¤ä¿¡æ¯GroupArrå’Œæ‰€æœ‰çš„å¥½å‹ä¿¡æ¯FriendArrï¼Œå†é€šè¿‡å»ºç«‹WebSocketæˆ¿é—´çš„è§„åˆ™åŠ å…¥åˆ°å¯¹åº”çš„æˆ¿é—´ï¼Œç„¶åä½¿ç”¨vuexæ´¾å‘æœ€æ–°çš„æ•°æ®ã€‚
#### æ•°æ®å¤„ç†
ç¾¤çš„æ•°æ®ç±»å‹
```js
// ç¾¤ç»„
interface Group {
  groupId: string;
  userId: string; // ç¾¤ä¸»id
  groupName: string;
  notice: string;
  messages: GroupMessage[];
  createTime: number;
}
```
å¥½å‹çš„æ•°æ®ç±»å‹
```js
// å¥½å‹
interface Friend {
  userId: string;
  username: string;
  avatar: string;
  role?: string;
  tag?: string;
  messages: FriendMessage[];
  createTime: number;
}
```
æˆ‘æ›¾ç»ç”¨å¯¹è±¡æ•°ç»„ [ Friends1 , friend2 ] è¿™æ ·çš„ç»“æ„å»ç®¡ç†æ‰€æœ‰çš„ç¾¤å’Œæ‰€æœ‰çš„å¥½å‹æ•°æ®ï¼Œä½†æ˜¯ç¨å¾®åŠ¨ä¸€ä¸‹è„‘ç­‹å°±çŸ¥é“ï¼Œè¿™æ ·çš„ç»“æ„éå¸¸ä¸åˆ©äºæŸ¥è¯¢/æ›´æ–°ã€‚æ¯æ¬¡ç”¨æˆ·çš„å¥½å‹åå­—å˜äº†æˆ–è€…å¤´åƒå˜äº†å°±å¾—éå†æŸ¥æ‰¾ä¸€éæ•°ç»„æ‰èƒ½æ›´æ–°ç›¸åº”ä¿¡æ¯ã€‚ <br>
åæ¥æˆ‘ç”¨å¯¹è±¡çš„ç»“æ„ï¼Œä¼˜åŒ–äº†èŠå¤©å®¤çš„ä»£ç ã€‚æˆ‘ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡gatheræ¥ç®¡ç†ç¾¤ç»„/å¥½å‹çš„ä¿¡æ¯ï¼Œ gatherçš„é”®ä¸ºgroupId/userIdï¼Œ å€¼ä¸ºå¯¹åº”çš„ç¾¤/å¥½å‹çš„ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹
```js
gather = {
 'userId': {
   userId: 'userId'
   username: 'xxx'
   messages: [];
   ...
 }
}
```
æ¯ä¸ªç¾¤å’Œç”¨æˆ·éƒ½æœ‰ç‹¬ä¸€æ— äºŒçš„idï¼Œæ‰€ä»¥æ— éœ€æ‹…å¿ƒé‡å¤ã€‚ä½¿ç”¨è¿™æ ·çš„ç»“æ„åï¼Œæ›´æ–°æ•°æ®ä¾¿éå¸¸çš„è½»æ¾ï¼Œåªéœ€è¦æ‹¿åˆ°éœ€è¦æ›´æ–°çš„idï¼Œç„¶åç›´æ¥è¦†ç›–gather.idå¯¹åº”çš„å€¼å°±è¡Œäº†

### vuex
èŠå¤©å®¤æ¶‰åŠåˆ°æ•°æ®çš„å³æ—¶æ›´æ–°å’Œå„ä¸ªvueç»„ä»¶çš„æ•°æ®åŒæ­¥ï¼Œå¤„ç†è¿™æ ·çš„ä¸šåŠ¡åœºæ™¯æ˜¯vuexçš„å¼ºé¡¹ã€‚ æˆ‘æŠŠå»ºç«‹WebSocketè¿æ¥çš„å‡½æ•°å†™åœ¨äº†vuexçš„actionä¸­ï¼Œåœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåè°ƒèµ·è¿æ¥å‡½æ•°ï¼Œä¸‹é¢æ˜¯ç²¾ç®€åçš„ä»£ç ã€‚
```js
// actions.ts
const actions: ActionTree<ChatState, RootState> = {
  // åˆå§‹åŒ–WebSocket
  async connectSocket({commit, state, dispatch, rootState}, callback) {
    // WebSocketè¿æ¥å»ºç«‹
    socket.on('connect', async () => {
      // è®¢é˜…ç¾¤æ¶ˆæ¯æ—¶é—´
      socket.on('groupMessage', (res: any) => {
        console.log('on groupMessage', res)
        if (!res.code) {
          // å¯¹ç¾¤æ¶ˆæ¯è¿›è¡Œå¤„ç†
          commit(ADD_GROUP_MESSAGE, res.data)
        }
      })
    }
  }
```
ä¸å¾—ä¸è¯´vuex-classè¿™ä¸ªåº“å¸®äº†æˆ‘å¾ˆå¤§çš„å¿™ï¼Œå®ƒæ˜¯vuexç»“åˆtypescriptå¼€å‘çš„å¾ˆå¥½çš„ç²˜åˆå‰‚ã€‚
ä½¿ç”¨äº†vuex-classï¼Œé‚£ä¹ˆåœ¨vueç»„ä»¶ä¸­è°ƒç”¨vuexçš„æ–¹æ³•åªéœ€è¦è¿™ä¹ˆå†™ï¼š
```js
// GenalChat.vue
import { namespace } from 'vuex-class'
const appModule = namespace('app')
export default class GenalChat extends Vue {
  @appModule.Getter('user') user: User;
  @appModule.Action('login') login: Function;
}
```
### æ€»ç»“
&emsp;&emsp;ç›®å‰èŠå¤©å®¤å·²ç»å®Œæˆæ—¥å¸¸èŠå¤©çš„åŸºç¡€åŠŸèƒ½ï¼Œå› ä¸ºèŠå¤©å®¤çš„æ•°æ®ç»“æ„åŸºæœ¬éƒ½å¤§åŒå°å¼‚ï¼Œå› æ­¤ç›®å‰çš„èŠå¤©å®¤æ¶æ„æ˜¯éå¸¸åˆ©äºåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•å’Œæ–°å¢åŠŸèƒ½çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»Šåä¹Ÿä¼šé™†ç»­å¼€å‘å¾ˆå¤šé…·ç‚«çš„åŠŸèƒ½ï¼Œå–œæ¬¢çš„æœ‹å‹ç»™ä¸ªstaré¼“åŠ±ä¸€ä¸‹æˆ‘å§ï¼

### é¡¹ç›®åœ°å€
githubï¼š [genal-chat](https://github.com/genaller/genal-chat)







