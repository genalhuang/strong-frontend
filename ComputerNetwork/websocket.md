### WebSocket
WebSocket 可以实现客户端与服务器间双向、基于消息的文本或二进制数据传输。

### 特点
1. 接收文本和二进制数据（ArrayBuffer和blob） ，可以接收 UTF-8 编码的 DOMString 对象（ DOMString 是一个UTF-16字符串。由于JavaScript已经使用了这样的字符串，所以DOMString 直接映射到一个String），也可以接收 ArrayBuffer、ArrayBufferView 或 Blob 等二进制数据
2. 开放性 HTTP 握手用于协商连接参数
3. 二进制消息分帧机制用于支持低开销的基于消息的文本和二进制数据传输。
WebSocket 使用了自
定义的二进制分帧格式（图 17-1），把每个应用消息切分成一或多个帧，发送到目
的地之后再组装起来，等到接收到完整的消息后再通知接收端。


*扩展ArrayBuffer和blob的区别
Blob 对象表示一个二进制文件的数据内容，比如一个图片文件的内容就可以通过Blob 对象读写。 它通常用来读写文件，它的名字是Binary Large Object （二进制大型对象）的缩写。 它与ArrayBuffer 的区别在于，它用于操作二进制文件，而ArrayBuffer 用于操作内存。

### 子协议协商
HTTP 或 XHR 请求不同——它们是通过每次请求和响应的 HTTP 首部来
沟通元数据，WebSocket 并没有等价的机制。因此，如果需要沟通关于消息的元数
据，客户端和服务器必须达成沟通这一数据的子协议。
1. 在 WebSocket 握手期间发送子协议数组
2. 检查服务器选择了哪个子协议

### 协议扩展
• 多路复用扩展（A Multiplexing Extension for WebSockets）
这个扩展可以将 WebSocket 的逻辑连接独立出来，实现共享底层的 TCP 连接。
• 压缩扩展（Compression Extensions for WebSocket） 给 WebSocket 协议增加了压缩功能。

### 使用http升级协商
考虑到安全和保密，很多用户都只开放有限的端口，通常只有 80
（HTTP）和 443（HTTPS）。正因为如此，WebSocket 协商是通过 HTTP Upgrade
流进行的，这样可以确保与现有网络策略及基础设施兼容。

### 缺点
浏览器是为 HTTP 数据传输而优化的，它理解 HTTP 协议，提供各种服务，比如认
证、缓存、压缩，等等。于是，XHR 请求自然而然就继承了所有这些功能。
相对来说，流式数据处理可以让我们在客户端和服务器间自定义协议，代价是错过
浏览器提供的很多服务：初次 HTTP 握手可以执行某些连接参数的协商，而一旦建
立会话，所有后续客户端与服务器间的数据流对浏览器都将是不透明的。这样来看，
自定义应用协议的灵活性也有缺点，应用可能必须实现自已的逻辑来填充某些功能
空白，比如缓存、状态管理、元数据交付，等等。

### 部署websocket基础设施
我们没有权限控制客户网络的策略。事实上，某些网络甚至会完全屏蔽 WebSocket
通信，而这正是必须有备用机制的原因。类似地，我们也没有权限控制外部网络
中的代理。可是，这里可以借助 TLS ！通过建立一条端到端的加密信道，可以让
WebSocket 通信绕过所有中间代理。

### 优化参考
• 使用安全 WebSocket（基于 TLS 的 WSS）实现可靠的部署。
• 密切关注腻子脚本的性能（如果使用腻子脚本）。
• 利用子协议协商确定应用协议。
• 优化二进制净荷以最小化传输数据。
• 考虑压缩 UTF-8 内容以最小化传输数据。
• 设置正确的二进制类型以接收二进制净荷。
• 监控客户端缓冲数据的量。
• 切分应用消息以避免队首阻塞。
• 合用的情况下利用其他传输机制。